@using SilverDawn.SilverModel.UML.Extensions;
@using SilverDawn.SilverModel.UML.Interfaces.Classes;
@using SilverDawn.SilverModel.UML.Classes;
// ALLOWOVERWRITE

using System;
using System.Collections.Generic;
using System.IO;
using System.Net.Http;
using System.Runtime.Serialization.Json;
using System.Runtime.Serialization;
using System.Text;
using System.Threading.Tasks;
using @(Model.Diagram.Name).Transactions.Model;
using @(Model.Diagram.Name).Views.Model;

namespace @(Model.Diagram.Name).Transactions
{
    public  class @(Model.Classifier.Name)Transactions
    {
        public async Task<@(Model.Classifier.Name)View> @(Model.Classifier.Name)Add(@(Model.Classifier.Name)Add add)
        {
            string json = "";

            var client = new HttpClient();

            using (var ms = new MemoryStream())
            {
                var serializer = new DataContractJsonSerializer(typeof(@(Model.Classifier.Name)Add));
                serializer.WriteObject(ms, add);
                ms.Position = 0;
                StreamReader sr = new StreamReader(ms);
                json = sr.ReadToEnd();
            }

            var stream = await client.PostAsync("@(Model.Diagram["REST Metadata","REST Server URL"])/api/@(Model.Classifier.Name.LowerFirst())", new StringContent(json, Encoding.UTF8, "application/json"));

            using (var ms = new MemoryStream())
            {
                var serializer = new DataContractJsonSerializer(typeof(@(Model.Classifier.Name)View),new DataContractJsonSerializerSettings()
            	{
                	DateTimeFormat = new DateTimeFormat("yyyy-MM-dd'T'HH:mm:ss")
            	});
                await stream.Content.CopyToAsync(ms);
                ms.Position = 0;
                var view = serializer.ReadObject(ms) as @(Model.Classifier.Name)View;
                return view;
            }
        }
 
        public async Task<@(Model.Classifier.Name)View> @(Model.Classifier.Name)Update(@(Model.Classifier.Name)Update update)
        {
            string json = "";

            var client = new HttpClient();

            using (var ms = new MemoryStream())
            {
                var serializer = new DataContractJsonSerializer(typeof(@(Model.Classifier.Name)Update),new DataContractJsonSerializerSettings()
            	{
                	DateTimeFormat = new DateTimeFormat("yyyy-MM-dd'T'HH:mm:ss")
            	});
                serializer.WriteObject(ms, update);
                ms.Position = 0;
                StreamReader sr = new StreamReader(ms);
                json = sr.ReadToEnd();
            }

            var stream = await client.PutAsync($"@(Model.Diagram["REST Metadata","REST Server URL"])/api/@(Model.Classifier.Name.LowerFirst())/{update.@(GetPrimaryKey(@Model.Classifier))}", new StringContent(json, Encoding.UTF8, "application/json"));

            using (var ms = new MemoryStream())
            {
                var serializer = new DataContractJsonSerializer(typeof(@(Model.Classifier.Name)View));
                await stream.Content.CopyToAsync(ms);
                ms.Position = 0;
                var view = serializer.ReadObject(ms) as @(Model.Classifier.Name)View;
                return view;
            }
        }

    }
}

@functions{
 
 	public static string GetPrimaryKey(IType iType)
 	{
 		if (iType is IClassifier)
 		{
 		return GetPrimaryKey((IClassifier)iType);
 		}
 		
 		return "";
 	}
 	
 
    public static string GetPrimaryKey(IClassifier umlClass)
    {
    	foreach (var att in umlClass.Attributes())
		{
			if (att["Database General Metadata","Primary Key"]=="True")
			{
				return att.Name;
			}
		}    	
    	return "";
    }
 
 	 public static string GetPrimaryDescription(IClassifier umlClass)
    {
    	foreach (var att in umlClass.Attributes())
		{
			if (att["Database General Metadata","Primary Key"]=="True")
			{
				return att.Description;
			}
		}    	
    	return "";
    }
 
 
 	public static string GetPrimaryType(IType iType)
 	{
 		
 		if (iType is IClassifier)
 		{
 		return GetPrimaryType((IClassifier)iType);
 		}
 		
 		return "";
 	}
 
    public static string GetPrimaryType(IClassifier umlClass)
    {
    	foreach (var att in umlClass.Attributes())
		{
			if (att["Database General Metadata","Primary Key"]=="True")
			{
				return  @att.Type.TypeName("C#");
				
			}
		}    	
    	return "";
    }
 
}