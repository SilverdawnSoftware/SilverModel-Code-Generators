@using System;
@using System.Collections.Generic;
@using System.Linq;
@using SilverDawn.SilverModel.UML.Extensions;
@using SilverDawn.SilverModel.UML.Interfaces.Classes;
@using SilverDawn.SilverModel.UML.Classes;
@using System.Text;
@using SilverDawn.SilverModel.Interfaces;
// ALLOWOVERWRITE

using System;
using System.Collections.Generic;
using Microsoft.EntityFrameworkCore;
using System.Linq;
using System.Threading.Tasks;
using SilverdawnSoftware.Exceptions;
@(GetUsings(Model.Classifier))

namespace @GetNameSpaceForClass(Model.Classifier)
{
    public partial class @(Model.Classifier.Name)Views
    {
   		@{foreach(var operation in Model.Classifier.Operations()){
   		var dbObjectName=GetLookupObject(operation,Model.Output).Name;
   			if (HasMany(operation))
   			{
   		@:public List<@(operation.Type.TypeName("C#"))> @(operation.Name)(@(GetParameters(operation)))
   		@:{
   			@:try
	            @:{
	            @:var result=new List<@(operation.Type.TypeName("C#"))>();
	            @:using (var db=new @(GetDbContext(operation,Model.Output))())
	            @:{

		         @:  	var @(dbObjectName.LowerFirst())s = db.@(dbObjectName)s.Where(w => @(GetWhere(operation,Model.Output)));
		         @:    	foreach(var @(dbObjectName.LowerFirst()) in @(dbObjectName.LowerFirst())s)
				 @:    	{
				  @:    		var toAdd=new @(operation.Type.TypeName("C#"))();
				 foreach(var attr in GetLookupObject(operation,Model.Output).Attributes())
				 {
				 		if (((IClass)operation.Type).Attributes().Any(w=>w.Name==attr.Name))
				 		{
				 			var opAttr=((IClass)operation.Type).Attributes().First(w=>w.Name==attr.Name);
				 		
		         @:   		toAdd.@(opAttr.Name) = @(dbObjectName.LowerFirst()).@(attr.Name);
		         		}
		         
				 }
				@:       result.Add(toAdd);
				@:		}

	                
	            @:}
	            @:return result;
	            @:}
	            @:catch (Exception e)
	            @:{
	            @:    var log = new LogExceptions();
	            @:    log.Log(LogLevel.Error,e);
	            @:    throw;
	            @:}
   			@:}
   		
   		@:
   		}
   		else
   		{
   		@:public @(operation.Type.TypeName("C#")) @(operation.Name)(@(GetParameters(operation)))
   		@:{
   			@:try
	            @:{
	            @:var result=new @(operation.Type.TypeName("C#"))();
	            @:using (var db=new @(GetDbContext(operation,Model.Output))())
	            @:{
	               @: if (db.@(GetLookupObject(operation,Model.Output).Name)s.Any(w => @(GetWhere(operation,Model.Output))))
	                @:{
	                 @:   var @(dbObjectName.LowerFirst()) = db.@(GetLookupObject(operation,Model.Output).Name)s.First(w => @(GetWhere(operation,Model.Output)));
					 foreach(var attr in GetLookupObject(operation,Model.Output).Attributes())
					 {
					 		if (((IClass)operation.Type).Attributes().Any(w=>w.Name==attr.Name))
					 		{
					 			var opAttr=((IClass)operation.Type).Attributes().First(w=>w.Name==attr.Name);
					 		
	                 @:   result.@(opAttr.Name) = @(dbObjectName.LowerFirst()).@(attr.Name);
	                 		}
					 }
	                @:}
	                
	            @:}
	            @:return result;
	            @:}
	            @:catch (Exception e)
	            @:{
	            @:    var log = new LogExceptions();
	            @:    log.Log(LogLevel.Error,e);
	            @:    throw;
	            @:}
   			@:}
   		
   		@:
   		}
   		
   		}
   
   		@:}
   
   
   
    }    
}


@functions{


	public static string GetUsings(IClassifier iClass)
	{
		var usings=new List<string>();
		
		foreach(var operation in iClass.Operations())
		{			
			var using1="using "+GetNameSpaceForClass((IClass)operation.Type)+";";
			if (!usings.Any(w=>w==using1))
				usings.Add(using1);
				
			var using2="using "+GetNameSpaceForClass(GetLookupObject(operation,null))+";";
			if (!usings.Any(w=>w==using2))
				usings.Add(using2);	
				
			foreach(var para in operation.OwnedParameters)
			{
				if (para.Type is IClass)
				{
					var using3="using "+GetNameSpaceForClass((IClass)para.Type)+";";
					if (!usings.Any(w=>w==using3))
					usings.Add(using3);			
				}
			}
		}



        var result=new StringBuilder();
		foreach(var add in usings)
		{
			result.AppendLine(add);
		}
		
		return result.ToString();
	}


	public static string GetNameSpaceForClass(IClassifier iClass)
	{
		return GetNameSpaceForModel((IModel)iClass.Owner);
	}
	
	public static string GetNameSpaceForModel(IModel model)
	{
		
		if (model.Parent is IModel)
		{
			return GetNameSpaceForModel((IModel)model.Parent)+"."+model.Name;
		}
		if (model.Parent is ISolution)
		{
			return ((ISolution)model.Parent).Name +"."+ model.Name;
		}
		
		return "";
	}
	
	

	public static bool HasMany(IOperation iOperation)
	{
		if (iOperation.Upper.Trim()=="*")
			return true;
		
		int intCheck;
		if (int.TryParse(iOperation.Upper,out intCheck))
			if (intCheck>1)
				return true;
		
		return false;
	}
	
 
 	public static string GetParameters(IOperation iOperation)
 	{
 		var ops=new StringBuilder();
 		
 		foreach(var para in iOperation.OwnedParameters)
 		{
 			
 			ops.Append(para.Type.TypeName("C#")+" "+para.Name.LowerFirst()+",");
 		
		} 		
 		return ops.ToString().Substring(0, ops.Length - 1);
 	}
 	
 	public static IClass GetLookupObject(IOperation iOperation, IOutput output)
 	{
 		return (IClass)((IClass)iOperation.Type).RelatedClassifier;
 	}
 	
 	public static string GetWhere(IOperation iOperation, IOutput output)
 	{
 		var ops=new StringBuilder();
 	
 		foreach(var para in iOperation.OwnedParameters)
 		{
 		
 			foreach(var prop in ((IClass)para.Type).OwnedProperties)
 			{
 			   
				output.WriteLine(prop["Query","IsWhere"]);
				if (prop["Query Metadata","IsWhere"]=="True")
	 			{
	 				output.WriteLine(prop.RelatedField.Class.Name);
	 				output.WriteLine(((IClass)iOperation.Type).Name);
	 			
	 				if (prop.RelatedField.Class.Name==((IClass)iOperation.Type).RelatedClassifier.Name)
	 				{
	 					ops.Append("w."+prop.RelatedField.Name+"=="+para.Name.LowerFirst()+"."+prop.Name+" && ");
	 				}
	 				else
	 				{
	 					ops.Append("w."+prop.RelatedField.Class.Name+"."+prop.RelatedField.Name+"=="+para.Name.LowerFirst()+"."+prop.Name+" && ");
	 				}
	 			}
 			}
		} 
		
		if (ops.Length <5) return "";
		
		return ops.ToString().Substring(0, ops.Length - 4);
 	}
 	
 	
 
    public static string GetPrimaryKey(IClassifier umlClass)
    {
    	foreach (var att in umlClass.Attributes())
		{
			if (att["Database General Metadata","Primary Key"]=="True")
			{
				return att.Name;
			}
		}    	
    	return "";
    }
    
    public static string GetDbContext(IOperation iOperation, IOutput output)
 	{
 		foreach(var para in iOperation.OwnedParameters)
 		{
 		
 			foreach(var prop in ((IClass)para.Type).OwnedProperties)
 			{
 			   
				output.WriteLine(prop["Query","IsWhere"]);
				if (prop["Query Metadata","IsWhere"]=="True")
	 			{
	 			 
	 				return prop.RelatedField.Class.GetModel()["Entity Framework Core","DBContextName"];
	 			}
 			}
		} 
		
		return "";
 	}
   
    
}
