@using System;
@using System.Collections.Generic;
@using System.Linq;
@using SilverDawn.SilverModel.UML.Extensions;
@using SilverDawn.SilverModel.UML.Interfaces.Classes;
@using SilverDawn.SilverModel.UML.Classes;
@using System.Text;
// ALLOWOVERWRITE

using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using SilverdawnSoftware.Exceptions;
using SilverdawnSoftware.Invoice.RESTAPI.Services;

@(GetUsings(Model.Diagram))


namespace @(Model.Diagram["REST Metadata","REST API Namespace"].AsString())
{

	
    public partial class @(Model.Diagram.Name)APIController : Controller
    {
   		private readonly IOrleansService _orleansService;

        public @(Model.Diagram.Name)APIController(IOrleansService orleansService)
        {
            _orleansService = orleansService;
        }
    
       @{foreach(var umlClass in Model.Diagram.Classes())
       {
       		var queryResult=umlClass["Query Metadata","Query Result"].AsClass();
       		switch(umlClass["REST Metadata","Method"].AsString())
       		{
       			case "GET":
       			break;
       			
       			case "POST":
       			
@:    	  /// <summary>
@:        /// @(umlClass.Description)
@:        /// </summary>   	
@:    	[Route("@(BuildRoute(umlClass))")]
@:    	[HttpPost]
@:        public async Task<ActionResult<I@(queryResult.Name)>> Add([FromBody]@(umlClass.Name) @(umlClass.Name.LowerFirst()))
@:        {
@:            try
@:            {
@:                var grain = _orleansService.Client.GetGrain<I@(umlClass.Name)Command>(0);
@:                var result=await  grain.@(umlClass.Name)(@(umlClass.Name.LowerFirst()));
@:                if (result.__CQRSSuccessful)
@:                   return new ActionResult<I@(queryResult.Name)>(result);
@:                else
@:                {
@:                    return new ContentResult() {StatusCode = result.__CQRSStatusCode, Content = result.__CQRSErrorMessage, ContentType = "text/plain"};
@:                }
@:            }
@:            catch (Exception e)
@:            {
@:                 LogFactory.GetLogger().Log(LogLevel.Error,e);
@:                 return new ContentResult() { StatusCode = 500, Content = "Fatal API Error", ContentType = "text/plain" };     
@:            } 
@:        }
       			break;
       			case "PUT":       			
@:         /// <summary>
@:        /// @(umlClass.Description)
@:        /// </summary>	
@:    	[Route("@(BuildRoute(umlClass))")]
@:    	[HttpPut]
@:        public async Task<ActionResult<I@(queryResult.Name)>> Update([FromRoute]int id,[FromBody]@(umlClass.Name) @(umlClass.Name.LowerFirst()))
@:        {
@:            try
@:            {
@:               var grain = _orleansService.Client.GetGrain<@(umlClass.Name)Command>(0);
@:               var result=await grain.@(umlClass.Name)(@(umlClass.Name.LowerFirst()));
@:               if (result.__CQRSSuccessful)
@:                    return new ActionResult<I@(queryResult.Name)>(result);
@:                else
@:                {
@:                    return new ContentResult() {StatusCode = result.__CQRSStatusCode, Content = result.__CQRSErrorMessage, ContentType = "text/plain"};
@:                }
@:            }
@:            catch (Exception e)
@:            {
@:                 LogFactory.GetLogger().Log(LogLevel.Error,e);
@:                 return new ContentResult() { StatusCode = 500, Content = "Fatal API Error", ContentType = "text/plain" };   
@:            }                      
@:        }
       			break;
       			
       			case "DELETE":
@:         /// <summary>
@:        /// @(umlClass.Description)
@:        /// </summary>
@:    	[Route("@(BuildRoute(umlClass))")]
@:    	[HttpDelete]
@:        public async Task<ActionResult> Delete([FromRoute]int id,[FromBody]@(umlClass.Name) @(umlClass.Name.LowerFirst()))
@:        {
@:            try
@:            {
@:                var grain = _orleansService.Client.GetGrain<@(umlClass.Name)Command>(0);
@:                var result=await grain.@(umlClass.Name)(@(umlClass.Name.LowerFirst()));
@:                if (result.__CQRSSuccessful)
@:                   return new ContentResult() {StatusCode = 200};
@:                else
@:                {
@:                    return new ContentResult() {StatusCode = result.__CQRSStatusCode, Content = result.__CQRSErrorMessage, ContentType = "text/plain"};
@:                }
@:            }
@:            catch (Exception e)
@:            {
@:                 LogFactory.GetLogger().Log(LogLevel.Error,e);
@:                 return new ContentResult() { StatusCode = 500, Content = "Fatal API Error", ContentType = "text/plain" };          
@:            } 
@:        }
       			break;
       		}
         }
       }
    	
    	
        
    }
}




@functions{
 
 	public static string GetNameSpaceForClass(IClassifier iClass)
	{
		return GetNameSpaceForModel((IModel)iClass.Owner);
	}
 
 	public static string GetNameSpaceForModel(IModel model)
	{
		
		if (model.Parent is IModel)
		{
			return GetNameSpaceForModel((IModel)model.Parent)+"."+model.Name;
		}
		if (model.Parent is ISolution)
		{
			return ((ISolution)model.Parent).Name +"."+ model.Name;
		}
		
		return "";
	}
	
    public static string GetPrimaryKey(IClassifier umlClass)
    {
    	foreach (var att in umlClass.AllAttributes())
		{
			if (att["Database General Metadata","Primary Key"].AsString()=="True")
			{
				return att.Name;
			}
		}
    	
    	return "";
    }
    
    public static string BuildRoute(IClass umlClass)
    {
    	string route="api/";
    	
    	route=route+umlClass["REST Metadata","Resource"].AsString();
    	
    	if (umlClass.Attributes().Any(w=>w["REST Metadata","ResourceId"].AsBoolean()==true))
    	{
    		route=route+@"/{"+umlClass.Attributes().First(w=>w["REST Metadata","ResourceId"].AsBoolean()==true).Name+"}";
    	}
    	
    	if (umlClass["REST Metadata","Action"].AsString().Length>0)
    	{
    		route=route+@"/"+umlClass["REST Metadata","Action"].AsString();
    	}
    	
    	
    	return route;
    	
    }
    
    public static string GetUsings(IModel model)
	{
		var usings=new List<string>();
		
		foreach(var umlClass in model.Classes())
		{
			var refclass=umlClass["Query Metadata","Query Result"].AsClass();
			if (refclass is IClass)
			{
				var using1="using "+refclass.GetModel().QualifiedName.Replace("::",".")+";";
				if (!usings.Any(w=>w==using1))
					usings.Add(using1);
			}
			
			var commandClassUsing="using "+ GetNameSpaceForClass(umlClass)+";";
			if (!usings.Any(w=>w==commandClassUsing))
					usings.Add(commandClassUsing);
		}

        var result=new StringBuilder();
		foreach(var add in usings)
		{
			result.AppendLine(add);
		}
		
		return result.ToString();
	}
    
 
}
