@using SilvaDawn.SilvaModel.UML.Extensions;
@using SilvaDawn.SilvaModel.UML.Interfaces.Classes;
@using SilvaDawn.SilvaModel.UML.Classes;
// ALLOWOVERWRITE

import * as angular from "angular";

import {I@(Model.Classifier.Name)View} from "../Models/@(Model.Classifier.Name)View";
import {@(Model.Classifier.Name)View} from "../Models/@(Model.Classifier.Name)View";

import {@(Model.Classifier.Name)Service} from "../Services/@(Model.Classifier.Name)Service";


@{
var UsedCheck=new List<string>();
}

// Add service imports
 @foreach (var att in Model.Classifier.AllAttributes())	    	{
						
		    		if (att.Type is IClass && att.Type.ElementId!=Model.Classifier.ElementId)
		    		{
		    		    
		    		 	var refclass=(IClass)att.Type;
		    		 	if (!UsedCheck.Any(w=>w==refclass.Name))
		    		 	{
<text>import {@(refclass.Name)Service} from "../../@(refclass.Name)/Services/@(refclass.Name)Service"</text>	
							UsedCheck.Add(refclass.Name);
						}
		    		}
	    		
    		}	
    		
//Add Target Assoications    

   					
  @foreach (var att in Model.Classifier.GetSourceAssociation())	    	{						
		    		 	if (!UsedCheck.Any(w=>w==att.GetTargetMemberEnd().Type.Name))
		    		 	{
<text>import {@(att.GetTargetMemberEnd().Type.Name)Service} from "../../@(att.GetTargetMemberEnd().Type.Name)/Services/@(att.GetTargetMemberEnd().Type.Name)Service"</text>	
							UsedCheck.Add(att.GetTargetMemberEnd().Type.Name);
						}
		    			    		
    		}	   		
    		
// Add view Models Imports
 @{UsedCheck=new List<string>();}
        @foreach (var att in Model.Classifier.AllAttributes())	    	{
						
		    		if (att.Type is IClass && att.Type.ElementId!=Model.Classifier.ElementId)
		    		{
		    		 	var refclass=(IClass)att.Type;
		    		 	if (!UsedCheck.Any(w=>w==refclass.Name))
		    			{
<text> import { I@(refclass.Name)View } from "../../@(refclass.Name)/Models/@(refclass.Name)View";</text>
						UsedCheck.Add(refclass.Name);
						}
		    		}
	    		
    		}       

// Add  Target Assoications view Models
        @foreach (var att in Model.Classifier.GetSourceAssociation())	    	{
						
		    		
		    		 	if (!UsedCheck.Any(w=>w==att.GetTargetMemberEnd().Type.Name))
		    			{
<text> import { I@(att.GetTargetMemberEnd().Type.Name)View } from "../../@(att.GetTargetMemberEnd().Type.Name)/Models/@(att.GetTargetMemberEnd().Type.Name)View";</text>
						UsedCheck.Add(att.GetTargetMemberEnd().Type.Name);
						}
		    		}
	    		

@{
var primaryKey=GetPrimaryKey(Model.Classifier);
var hasPrimaryKey=!string.IsNullOrEmpty(primaryKey);
var loadCount=0;
}




    export interface IButtonClick {
    };

	// Scope
    export interface I@(Model.Classifier.Name)EditCtrlScope extends ng.IScope {

        loaded: boolean;
        @(Model.Classifier.Name.LowerFirst())View :I@(Model.Classifier.Name)View;
        @{UsedCheck=new List<string>();}
        @foreach (var att in Model.Classifier.AllAttributes())    	{
				
	    		if (att.Type is IClass && att.Type.ElementId!=Model.Classifier.ElementId)
	    		{
					var refclass=(IClass)att.Type;	
					if (!UsedCheck.Any(w=>w==refclass.Name))
		    		{					
	    				<text>@(refclass.Name.LowerFirst())s: I@(refclass.Name)View[];</text>
	    				UsedCheck.Add(refclass.Name);
					}
	    		}
	    	}
    	 @foreach (var att in Model.Classifier.GetSourceAssociation())    	{
					
					if (!UsedCheck.Any(w=>w==att.GetTargetMemberEnd().Type.Name))
		    		{					
	    				<text>@(att.GetTargetMemberEnd().Type.Name.LowerFirst())s: I@(att.GetTargetMemberEnd().Type.Name)View[];</text>
	    				UsedCheck.Add(att.GetTargetMemberEnd().Type.Name);
					}
	    		
	    	}
        save: IButtonClick;
    }

	
    export interface I@(Model.Classifier.Name)EditCtrlScopeRouteParams extends ng.route.IRouteParamsService {
      @if(hasPrimaryKey)      {
       <text> @(GetPrimaryKey(Model.Classifier).LowerFirst()): number;</text>
       }
       
       @foreach (var att in Model.Classifier.GetTargetAssociation())    	{ 
        <text> @(((IClassifier)att.GetSourceMemberEnd().Type).Name.LowerFirst())@(GetPrimaryKey((IClassifier)att.GetSourceMemberEnd().Type)): @(GetPrimaryType((IClassifier)att.GetSourceMemberEnd().Type));</text>
       }
    }

    export class @(Model.Classifier.Name)EditCtrl {
        public static $inject = [
            '$scope',
            '$routeParams',
            '$http',
            '@Model.Classifier.Name.LowerFirst()Service'
            @{UsedCheck=new List<string>();}
            @foreach (var att in Model.Classifier.AllAttributes())	    	{
						
		    		if (att.Type is IClass && att.Type.ElementId!=Model.Classifier.ElementId)
		    		{
		    		 	var refclass=(IClass)att.Type;
		    		 	if (!UsedCheck.Any(w=>w==refclass.Name))
		    			{
<text>       ,'</text>@(refclass.Name.LowerFirst())<text>Service'</text>
						UsedCheck.Add(refclass.Name);
						}
		    		}
	    		
    		}
    		
 @foreach (var att in Model.Classifier.GetSourceAssociation())	    	{
						
		    		
		    		 	if (!UsedCheck.Any(w=>w==att.GetTargetMemberEnd().Type.Name))
		    			{
<text>       ,'</text>@(att.GetTargetMemberEnd().Type.Name.LowerFirst())<text>Service'</text>
						UsedCheck.Add(att.GetTargetMemberEnd().Type.Name);
						}
		    		
	    		
    		}	    		
        ];

      

        constructor(private $scope: I@(Model.Classifier.Name)EditCtrlScope, private $routeParams: I@(Model.Classifier.Name)EditCtrlScopeRouteParams, private $http: ng.IHttpService, private @(Model.Classifier.Name.LowerFirst())Service: @(Model.Classifier.Name)Service
         @{UsedCheck=new List<string>();}
        @foreach (var att in Model.Classifier.AllAttributes())	    	{
						
		    		if (att.Type is IClass && att.Type.ElementId!=Model.Classifier.ElementId)
		    		{
		    		 	var refclass=(IClass)att.Type;
		    		 	if (!UsedCheck.Any(w=>w==refclass.Name))
		    			{
<text>,private </text>@refclass.Name.LowerFirst()<text>Service: </text>@refclass.Name<text>Service</text>
loadCount++;
						UsedCheck.Add(refclass.Name);
						}
		    		}
	    		
    		}
@foreach (var att in Model.Classifier.GetSourceAssociation())	    	{
						
		    		
		    		 	
		    		 	if (!UsedCheck.Any(w=>w==att.GetTargetMemberEnd().Type.Name))
		    			{
<text>,private </text>@att.GetTargetMemberEnd().Type.Name.LowerFirst()<text>Service: </text>@att.GetTargetMemberEnd().Type.Name<text>Service</text>
loadCount++;
						UsedCheck.Add(att.GetTargetMemberEnd().Type.Name);
						}
		    		
	    		
    		}    

        ) {
         var count = 0;
            var toLoad = @(loadCount);
           
			@{if (loadCount==0)
				{ <text>$scope.loaded = true;</text> }
			else { <text>$scope.loaded = false;</text> }
			}

            function dataLoaded() {
                count++;
                if (count >= toLoad) {
                    $scope.loaded = true;
                }
            }
        
       $scope.@(Model.Classifier.Name.LowerFirst())View = new @(Model.Classifier.Name)View();
        // Load Data for drop downs
         @{UsedCheck=new List<string>();}
        @foreach (var att in Model.Classifier.AllAttributes())	    	{
						
		    		if (att.Type is IClass && att.Type.ElementId!=Model.Classifier.ElementId)
		    		{
		    		 	var refclass=(IClass)att.Type;
		    		 	if (!UsedCheck.Any(w=>w==refclass.Name))
		    			{
<text> @(refclass.Name.LowerFirst())Service.get@(refclass.Name)s().then(function (data: I@(refclass.Name)View[]) {
                 dataLoaded();
                $scope.@(refclass.Name.LowerFirst())s = data;
            });
</text>
						UsedCheck.Add(refclass.Name);
						}
		    		}
	    		
    		}       
        
       // Load Data for tabs
         @{UsedCheck=new List<string>();}
        @foreach (var att in Model.Classifier.GetSourceAssociation())	    	{
						
		    		
		    		 	if (!UsedCheck.Any(w=>w==att.GetTargetMemberEnd().Type.Name))
		    			{
<text> @(att.GetTargetMemberEnd().Type.Name.LowerFirst())Service.get@(att.GetTargetMemberEnd().Type.Name)sFor@(Model.Classifier.Name)($routeParams.@(GetPrimaryKey(Model.Classifier).LowerFirst())).then(function (data: I@(att.GetTargetMemberEnd().Type.Name)View[]) {
                 dataLoaded();
                $scope.@(att.GetTargetMemberEnd().Type.Name.LowerFirst())s = data;
            });
</text>
						UsedCheck.Add(att.GetTargetMemberEnd().Type.Name);
						}
		    		
	    		
    		}        
        
          

			@if(hasPrimaryKey)			{

           <text>  if (!isNaN($routeParams.@(GetPrimaryKey(Model.Classifier).LowerFirst()))) {
                @(Model.Classifier.Name.LowerFirst())Service.get@(Model.Classifier.Name)($routeParams.@(GetPrimaryKey(Model.Classifier).LowerFirst())).then(function(data: I@(Model.Classifier.Name)View) {
                    $scope.@(Model.Classifier.Name.LowerFirst())View = data;
                    dataLoaded();
                });
            } </text>
        
        	
        <text>
        	 $scope.save = function() {
                if ($scope.@(Model.Classifier.Name.LowerFirst())View.@(GetPrimaryKey(Model.Classifier).LowerFirst()) == undefined || $scope.@(Model.Classifier.Name.LowerFirst())View.@(GetPrimaryKey(Model.Classifier).LowerFirst()) < 1) {
                    // add new
                    
                    @foreach (var att in Model.Classifier.GetTargetAssociation())    	{ 
                    var attType=(IClassifier)att.GetSourceMemberEnd().Type;
                    <text>
                    if ($routeParams.@(attType.Name.LowerFirst())@(GetPrimaryKey(attType)) != undefined || $routeParams.@(attType.Name.LowerFirst())@(GetPrimaryKey(attType)) > 0) {
                     @("") $scope.@(Model.Classifier.Name.LowerFirst())View.@(attType.Name.LowerFirst())@(GetPrimaryKey(attType)) = $routeParams.@(attType.Name.LowerFirst())@(GetPrimaryKey(attType));
                    }
                    </text>
                    }
                    @(Model.Classifier.Name.LowerFirst())Service.add@(Model.Classifier.Name)($scope.@(Model.Classifier.Name.LowerFirst())View).then(function(data: I@(Model.Classifier.Name)View) {
                        $scope.@(Model.Classifier.Name.LowerFirst())View = data;
                    });
                } else {
                    // update
                    @(Model.Classifier.Name.LowerFirst())Service.update@(Model.Classifier.Name)($scope.@(Model.Classifier.Name.LowerFirst())View).then(function (data: I@(Model.Classifier.Name)View) {
                        $scope.@(Model.Classifier.Name.LowerFirst())View = data;
                    });
                }
            };
            </text>
            }
        
        }
    }
    
   
 
 
 @functions{

string GetPrimaryKey(IClassifier iClass)
{
	foreach (var att2 in iClass.Attributes())
   	{
		if (att2["Entity Framework","EF Primary Key"]=="True")
		 return att2.Name;
	}
	
	return "";
}

string GetDescriptor(IClassifier iClass)
{
	foreach (var att2 in iClass.Attributes())
   	{
		if (att2["Entity Framework","Default Descriptor"]=="True")
		 return att2.Name;
	}
	
	return "";
}

public static string GetPrimaryType(IType iType)
 	{
 		if (iType is IClassifier)
 		{
 		return GetPrimaryType((IClassifier)iType);
 		}
 		
 		return "";
 	}
 
    public static string GetPrimaryType(IClassifier umlClass)
    {
    	foreach (var att in umlClass.Attributes())
		{
			if (att["Entity Framework","EF Primary Key"]=="True")
			{
				return  @att.Type.TypeName("TypeScript");
				
			}
		}    	
    	return "";
    }

}