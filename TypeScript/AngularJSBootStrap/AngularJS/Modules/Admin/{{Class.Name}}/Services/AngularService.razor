@using SilvaDawn.SilvaModel.UML.Extensions;
@using SilvaDawn.SilvaModel.UML.Interfaces.Classes;
@using SilvaDawn.SilvaModel.UML.Classes;
// ALLOWOVERWRITE

@{
var primaryKey=GetPrimaryKey(Model.Classifier);
}

import { IHttpService, IPromise, IScope, IQService, ILogService } from 'angular';

import * as angular from "angular";

import {@(Model.Classifier.Name)View} from "../Models/@(Model.Classifier.Name)View"


    export class @(Model.Classifier.Name)Service {

        public static $inject = ['$http', '$q', '$log', '$rootScope'];

        constructor(private $http: IHttpService, private $q: IQService, private $log: ILogService) {}


		get@(Model.Classifier.Name)s(): IPromise<any> {
	            var deferred = this.$q.defer();
	
	            this.$http.get('api/@(Model.Classifier.Name)/All')
	                .success(function (data) {
	                deferred.resolve(data);
	            }).error(function (msg, code) {
	                deferred.reject(msg);
	                this.$log.error(msg, code);
	            });
	            return deferred.promise;
	        }


		@if (!string.IsNullOrEmpty(primaryKey))
		{
	 	<text>get@(Model.Classifier.Name)(@(GetPrimaryKey(Model.Classifier).LowerFirst()): number): IPromise<any> {
	            var deferred = this.$q.defer();
	
	            this.$http.get('api/@(Model.Classifier.Name)/'+@(GetPrimaryKey(Model.Classifier).LowerFirst()))
	                .success(function (data) {
	                deferred.resolve(data);
	            }).error(function (msg, code) {
	                deferred.reject(msg);
	                this.$log.error(msg, code);
	            });
	            return deferred.promise;
	        }
	        
		@foreach (var att in Model.Classifier.GetTargetAssociation())
	    	{
	    		var parent=(IClass)att.GetSourceMemberEnd().Type;
	    		var parentKey=GetPrimaryKey(parent);
			
			<text>
			get@(Model.Classifier.Name)sFor@(parent.Name)(@(parentKey.LowerFirst()): number): IPromise<any> {
	            var deferred = this.$q.defer();
	
	            this.$http.get('api/@(parent.Name)/'+@(parentKey.LowerFirst())+'/@(Model.Classifier.Name)s')
	                .success(function (data) {
	                deferred.resolve(data);
	            }).error(function (msg, code) {
	                deferred.reject(msg);
	                this.$log.error(msg, code);
	            });
	            return deferred.promise;
	        }
	</text>    	
	    	}
	
	
	
			add@(Model.Classifier.Name)(add: @(Model.Classifier.Name)View): IPromise<any> {
	            var deferred = this.$q.defer();
	
	            this.$http.post('api/@(Model.Classifier.Name)',add)
	                .success(function (data) {
	                deferred.resolve(data);
	            }).error(function (msg, code) {
	                deferred.reject(msg);
	                this.$log.error(msg, code);
	            });
	            return deferred.promise;
	        }

			update@(Model.Classifier.Name)(update: @(Model.Classifier.Name)View): IPromise<any> {
	            var deferred = this.$q.defer();
	
	            this.$http.put('api/@(Model.Classifier.Name)/'+update.@(GetPrimaryKey(Model.Classifier).LowerFirst()),update)
	                .success(function (data) {
	                deferred.resolve(data);
	            }).error(function (msg, code) {
	                deferred.reject(msg);
	                this.$log.error(msg, code);
	            });
	            return deferred.promise;
	        }	
			delete@(Model.Classifier.Name)(@(GetPrimaryKey(Model.Classifier).LowerFirst()): number): IPromise<any> {
	            var deferred = this.$q.defer();
	
	            this.$http.delete('api/@(Model.Classifier.Name)/'+@(GetPrimaryKey(Model.Classifier).LowerFirst()))
	                .success(function (data) {
	                deferred.resolve(data);
	            }).error(function (msg, code) {
	                deferred.reject(msg);
	                this.$log.error(msg, code);
	            });
	            return deferred.promise;
	        }	</text>
}



    }
  

	


@functions{
 
 
 
 public static string GetDescriptor(IType iType)
 	{
 		if (iType is IClassifier)
 		{
 		return GetPrimaryKey((IClassifier)iType);
 		}
 		
 		return "";
 	}
 	
 
    public static string GetDescriptor(IClassifier umlClass)
    {
    	foreach (var att in umlClass.Properties())
		{
			if (att["Entity Framework","Default Descriptor"]=="True")
			{
				return att.Name;
			}
		}    	
    	return "";
    }
 
 
 	public static string GetPrimaryKey(IType iType)
 	{
 		if (iType is IClassifier)
 		{
 		return GetPrimaryKey((IClassifier)iType);
 		}
 		
 		return "";
 	}
 	
 
    public static string GetPrimaryKey(IClassifier umlClass)
    {
    	foreach (var att in umlClass.Properties())
		{
			if (att["Entity Framework","EF Primary Key"]=="True")
			{
				return att.Name;
			}
		}    	
    	return "";
    }
 
 	public static string GetPrimaryType(IType iType)
 	{
 		if (iType is IClassifier)
 		{
 		return GetPrimaryType((IClassifier)iType);
 		}
 		
 		return "";
 	}
 
    public static string GetPrimaryType(IClassifier umlClass)
    {
    	foreach (var att in umlClass.Properties())
		{
			if (att["Entity Framework","EF Primary Key"]=="True")
			{
				return  @att.Type.TypeName("C#");
				
			}
		}    	
    	return "";
    }
 
}

